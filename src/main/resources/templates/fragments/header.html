<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <header th:fragment="headerFragment" class="page-header">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />
        <!-- 웹소켓 -->
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        <script th:inline="javascript">
            let currentThemeIndex = 0;
            // 로고 색상 변경용
            const logo_img_paths = ["./img/logo_white.png", "./img/logo_black.png"];
            const logo_text = ["white", "black"];

            // 메인 컬러 변경용
            const root = document.documentElement; // :root 

            const main_color_values = [
                getComputedStyle(root).getPropertyValue('--main-color-dark'),
                getComputedStyle(root).getPropertyValue('--main-color-light')
            ];

            document.getElementById("toggle").addEventListener("click", function () {
                document.getElementsByTagName('body')[0].classList.toggle("dark-theme");

                currentThemeIndex = 1 - currentThemeIndex;  // 0과 1을 번갈아가며 토글
                // 이미지 경로를 토글
                document.getElementById('logo_img').src = logo_img_paths[currentThemeIndex];
                document.querySelector(".page-header__logo_text").style.color = logo_text[currentThemeIndex];
                // 메인 컬러 변경용
                root.style.setProperty('--main-color-now', main_color_values[currentThemeIndex]);
                console.log(root.style.getPropertyValue('--main-color-now'));
            });

            // websocket ~~~~~~~~
            let currentPoint = /*[[${currentPoint}]]*/0;
            let memInfoStompClient = null;
            let memId = 0;
            document.addEventListener("DOMContentLoaded", function () {
                memId = /*[[${memId}]]*/0;
                if(memId!==0) pointConnect();
            });
            var pointFlag = -1; // 아무 실행x
            function pointConnect() {
                var socket = new SockJS('/ws');

                memInfoStompClient = Stomp.over(socket);

                memInfoStompClient.connect({}, function (frame) {
                    memInfoStompClient.subscribe(`/topic/headerInfo/` + memId, function (response) {
                        try {
                            let headerInfo = JSON.parse(response.body);
                            console.log(headerInfo);
                            if(headerInfo.flag===2){
                                alert("포인트 부족");
                            }
                            if(headerInfo.flag===1){
                                // 정상
                                currentPoint = headerInfo.currentPoint;
                                document.getElementById("current-point").innerHTML = formatNumber(currentPoint);
                            }else if(headerInfo.flag===0 || headerInfo.flag===-1){
                                // 에러
                                alert("에러");
                            }
                            pointFlag = heaerInfo.flag;
                        } catch (err) {
                            console.log("에러 : " + err);
                        }
                    });
                });
            }

            function sendPointChange(point,pointKindCd) {
                memInfoStompClient.send(`/app/memPointChange`, {},JSON.stringify({
                    memId: Number(memId),
                    pointKindCd : pointKindCd,
                    currentPoint: Number(currentPoint),
                    pointChange: Number(point),
                    flag : -1
                }));
            }
        </script>
        <div class="page-header__inner">
            <!-- 헤더 사이드바(로고) -->
            <div class="page-header__sidebar">
                <div class="page-header__menu-btn"><button class="menu-btn ico_menu is-active"></button></div>
                <a href="/">
                    <div class="page-header__logo"><img src="/img/logo_white.png" alt="logo" id="logo_img"><span
                            class="page-header__logo_text">G A M M O A</span></div>
                </a>
            </div>
            <!-- 헤더 컨텐츠 -->
            <div class="page-header__content">
                <div class="page-header__search">
                    <div class="search">
                        <div class="search__input"><i class="ico_search"></i><input type="search" name="search"
                                placeholder="Search"></div>
                        <div class="search__btn"><button type="button"><i class="ico_microphone"></i></button></div>
                    </div>
                </div>

                <div class="page-header__action">
                    <div onclick="sendPointChange(100,'50001')">100 포인트 추가</div>
                    <div onclick="sendPointChange(-100,'50001')">100 포인트 감소</div>
                    <a th:if="${nickname}" class="action-btn wallet" href="/wallet"><i
                            class="fa-solid fa-coins ico_fontawesome"></i></a>
                    <div id="current-point"
                        th:text="${#numbers.formatInteger(#numbers.formatInteger(currentPoint,0),0,'COMMA')}"></div>
                    <a th:if="${nickname}" class="action-btn" href="06_chats.html"><i class="ico_message"></i><span
                            class="animation-ripple-delay1"></span></a>
                    <a th:if="${nickname}" class="action-btn" href="07_friends.html"><i
                            class="ico_notification"></i><span class="animation-ripple-delay2"></span></a>
                    <a th:if="${nickname}" th:href="@{logout}" class="action-btn"><i
                            class="fa-solid fa-right-from-bracket ico_logout"></i></a>
                    <a th:unless="${nickname}" th:href="@{login}" class="action-btn"><i
                            class="fa-solid fa-right-to-bracket ico_fontawesome"></i></a>

                    <a th:if="${nickname}" class="profile" href="08_wallet.html"><img src="/img/profile.png"
                            alt="profile"></a>
                </div>

            </div>
        </div>
        <script>
            function formatNumber(number) {
                return new Intl.NumberFormat('en-US').format(number);
            }
        </script>
    </header>

</body>

</html>